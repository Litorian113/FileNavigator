<style>
  :root {
    --font-stack: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    --primary-color: #000000; /* Swiss Style: Starkes Schwarz */
    --accent-color: #18A0FB; /* Figma Blue als Akzent */
    --bg-color: #FFFFFF;
    --text-color: #333333;
    --border-color: #E5E5E5;
    --spacing-unit: 8px;
  }

  body { 
    font-family: var(--font-stack); 
    padding: 0; 
    font-size: 13px; 
    line-height: 1.5;
    color: var(--text-color);
    background-color: var(--bg-color);
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    box-sizing: border-box;
  }

  .main-content-wrapper {
    padding: 24px;
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow-y: auto;
  }

  /* --- TOP NAV --- */
  .top-nav {
    display: flex;
    gap: 24px;
    border-bottom: 1px solid #eee;
    margin-bottom: 24px;
    padding-bottom: 0;
  }

  .nav-item {
    background: none;
    border: none;
    padding: 8px 0;
    cursor: pointer;
    font-weight: 500;
    color: #888;
    font-size: 13px;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    margin-bottom: -1px;
    flex: 0;
  }

  .nav-item:hover { color: #000; }

  .nav-item img {
    width: 16px;
    height: 16px;
    vertical-align: text-bottom;
    margin-right: 6px;
  }
  
  .nav-item.active {
    color: #000;
    font-weight: 600;
    border-bottom: 2px solid #000;
  }

  h2 { 
    margin-top: 0; 
    margin-bottom: 24px;
    font-weight: 700;
    font-size: 18px;
    letter-spacing: -0.02em;
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
    padding-bottom: 12px;
  }

  .container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    flex-grow: 1;
  }

  label {
    display: block;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 6px;
    color: #888;
  }

  input[type="text"], textarea { 
    width: 100%; 
    padding: 12px; 
    margin-bottom: 0; 
    box-sizing: border-box; 
    border: 1px solid var(--border-color);
    border-radius: 0; /* Swiss Style: Eher eckig */
    font-family: var(--font-stack);
    font-size: 13px;
    transition: border-color 0.2s;
    background: #FAFAFA;
  }

  input[type="text"]:focus, textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    background: #FFF;
  }

  textarea {
    resize: vertical;
    min-height: 120px;
    line-height: 1.6;
  }

  .button-group {
    display: flex;
    gap: 12px;
    margin-top: auto; /* Push to bottom */
    padding-top: 24px;
  }

  button { 
    padding: 12px 20px; 
    cursor: pointer; 
    font-family: var(--font-stack);
    font-weight: 600;
    font-size: 12px;
    border: none;
    border-radius: 0;
    transition: all 0.2s;
    flex: 1;
  }

  #save, #search-btn { 
    background-color: var(--primary-color); 
    color: white; 
  }
  
  #save:hover, #search-btn:hover {
    background-color: #333;
  }

  #ai-btn {
    flex: initial; /* Don't stretch like other buttons */
    padding: 6px;
    background-color: transparent;
    border: 1px solid var(--border-color);
    color: var(--text-color);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
  }

  #ai-btn:hover {
    border-color: var(--primary-color);
    background-color: #F5F5F5;
  }

  #cancel { 
    background-color: transparent; 
    border: 1px solid var(--border-color); 
    color: var(--text-color);
  }

  #cancel:hover {
    border-color: var(--primary-color);
  }
  
  .info-block {
    margin-bottom: 16px;
  }

  .sid-display { 
    font-family: 'Roboto Mono', monospace; 
    background: #F5F5F5; 
    padding: 12px; 
    border-left: 4px solid var(--accent-color);
    font-size: 11px;
    color: #555;
    word-break: break-all;
  }
  
  #editor-container, #search-container, #about-container { display: none; height: 100%; flex-direction: column; }
  
  /* Utility classes for visibility control via JS */
  .visible { display: flex !important; }

  .node-name-highlight {
    color: var(--primary-color);
    font-weight: 700;
  }
</style>

<div class="main-content-wrapper">
  <!-- TOP NAVIGATION -->
  <div class="top-nav">
    <button class="nav-item active" id="nav-search"><img src="assets/nav-png/search.svg" alt="Suche"> Suche</button>
    <button class="nav-item" id="nav-editor"><img src="assets/nav-png/editor.svg" alt="Editor"> Editor</button>
    <button class="nav-item" id="nav-about"><img src="assets/nav-png/about.svg" alt="About"> About</button>
  </div>

  <!-- Such-Container (sichtbar wenn nichts ausgew√§hlt ist) -->
  <div id="search-container" class="container visible">
  <div class="info-block">
    <label>Status</label>
    <div>Kein Frame ausgew√§hlt.</div>
  </div>
  
  <div class="info-block">
    <label>Suche</label>
    <input id="search-input" type="text" placeholder="Beschreibe, was du suchst...">
  </div>
  
  <div class="button-group">
    <button id="search-btn">AI Suche starten</button>
  </div>

  <!-- Export Button -->
  <div style="margin-top: 16px; border-top: 1px solid #eee; padding-top: 16px;">
    <button id="export-btn" style="background: white; color: #333; border: 1px solid #ccc; width: 100%;">
      üíæ Datenbank exportieren (.json)
    </button>
  </div>
</div>

<!-- Editor-Container (sichtbar wenn Frame ausgew√§hlt ist) -->
<div id="editor-container" class="container">
  <div class="info-block">
    <label>Ausgew√§hlter Frame</label>
    <div id="node-name" class="node-name-highlight"></div>
  </div>
  
  <div class="info-block">
    <label>System ID (SID)</label>
    <div id="sid-display" class="sid-display">-</div>
  </div>

  <div class="info-block" style="flex-grow: 1; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
      <label style="margin-bottom: 0;">Alt Beschreibung</label>
      <button id="ai-btn" title="AI Auto-Complete">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z"/><path d="M20 2v4"/><path d="M22 4h-4"/><circle cx="4" cy="20" r="2"/></svg>
      </button>
    </div>
    <textarea id="alt-text" placeholder="Stichworte eingeben und auf AI klicken..." style="flex-grow: 1;"></textarea>
  </div>
  
  <div class="button-group">
    <button id="cancel">Abbrechen</button>
    <button id="save">Speichern</button>
  </div>
</div>

<!-- About-Container -->
<div id="about-container" class="container">
  <h2>√úber FileNavigator</h2>
  
  <div class="info-block">
    <label>Was ist das?</label>
    <p>FileNavigator ist ein Figma-Plugin, das deine Frames mit AI-generierten Beschreibungen versieht und eine intelligente Suche erm√∂glicht.</p>
  </div>

  <div class="info-block">
    <label>Features</label>
    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
      <li><strong>AI Auto-Complete</strong>: Automatische Beschreibungsgenerierung via GPT-4o Vision</li>
      <li><strong>Semantische Suche</strong>: Finde Frames √ºber nat√ºrliche Sprache</li>
      <li><strong>SID-System</strong>: Jeder Frame erh√§lt eine eindeutige ID</li>
      <li><strong>Datenbank-Export</strong>: Exportiere alle Metadaten als JSON</li>
    </ul>
  </div>

  <div class="info-block">
    <label>Workflow</label>
    <ol style="margin: 0; padding-left: 20px; line-height: 1.8;">
      <li>Frame in Figma ausw√§hlen</li>
      <li>Plugin √∂ffnet automatisch den Editor</li>
      <li>‚ú®-Button klicken f√ºr AI-Beschreibung</li>
      <li>Speichern ‚Üí SID wird generiert</li>
      <li>√úber Suche jederzeit wiederfinden</li>
    </ol>
  </div>

  <div class="info-block">
    <label>Technologie</label>
    <p style="color: #666; font-size: 12px;">Figma Plugin API ‚Ä¢ OpenAI GPT-4o ‚Ä¢ TypeScript ‚Ä¢ esbuild</p>
  </div>
</div>

</div>

<script>
const editor = document.getElementById('editor-container');
const searchContainer = document.getElementById('search-container');
const aboutContainer = document.getElementById('about-container');
const nameDisplay = document.getElementById('node-name');
const sidDisplay = document.getElementById('sid-display');
const input = document.getElementById('alt-text');
const searchInput = document.getElementById('search-input');
const aiBtn = document.getElementById('ai-btn');

const navSearch = document.getElementById('nav-search');
const navEditor = document.getElementById('nav-editor');
const navAbout = document.getElementById('nav-about');

const searchBtn = document.getElementById('search-btn');
const exportBtn = document.getElementById('export-btn');

let apiKey = '';

// --- NAV LOGIC ---
function switchToView(viewName) {
  // Hide all containers
  searchContainer.classList.remove('visible');
  editor.classList.remove('visible');
  aboutContainer.classList.remove('visible');
  
  // Remove active state from all nav items
  navSearch.classList.remove('active');
  navEditor.classList.remove('active');
  navAbout.classList.remove('active');
  
  // Show selected container and activate nav item
  if (viewName === 'search') {
    searchContainer.classList.add('visible');
    navSearch.classList.add('active');
  } else if (viewName === 'editor') {
    editor.classList.add('visible');
    navEditor.classList.add('active');
  } else if (viewName === 'about') {
    aboutContainer.classList.add('visible');
    navAbout.classList.add('active');
  }
}

navSearch.onclick = () => switchToView('search');
navEditor.onclick = () => switchToView('editor');
navAbout.onclick = () => switchToView('about');

// Nachrichten vom Plugin (code.ts) empfangen
window.onmessage = (event) => {
  const msg = event.data.pluginMessage;

  if (msg.type === 'selection-empty') {
    switchToView('search');
    if (msg.apiKey) apiKey = msg.apiKey;
  } 
  else if (msg.type === 'wrong-type') {
    switchToView('search');
    if (msg.apiKey) apiKey = msg.apiKey;
  } 
  else if (msg.type === 'update-data') {
    switchToView('editor');
    
    input.value = msg.altText;
    sidDisplay.textContent = msg.sid;
    nameDisplay.textContent = msg.nodeName;
    if (msg.apiKey) apiKey = msg.apiKey;
  }
  else if (msg.type === 'search-data-response') {
    performAiSearch(msg.query, msg.data);
  }
  else if (msg.type === 'image-data') {
    analyzeImage(msg.bytes);
  }
  else if (msg.type === 'image-error') {
    resetAiBtn();
    alert("Fehler beim Bild-Export.");
  }
  else if (msg.type === 'export-json-result') {
    downloadJSON(msg.data);
  }
};

function resetAiBtn() {
  aiBtn.style.opacity = '1';
  aiBtn.style.cursor = 'pointer';
  aiBtn.disabled = false;
}

function bufferToBase64(buffer) {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return window.btoa(binary);
}

async function analyzeImage(bytes) {
  try {
    const base64Image = bufferToBase64(bytes);
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-4o", // Vision Model
        messages: [
          {
            role: "system",
            content: "Du bist ein UI/UX Experte und spezialisiert auf Barrierefreiheit. Analysiere den Screenshot dieses UI-Frames. Erstelle eine strukturierte Beschreibung, die sp√§ter hilft, diesen Frame √ºber eine Textsuche wiederzufinden. \n\nBitte folge diesem Format:\n1. **Zusammenfassung**: Was ist der Hauptzweck dieses Screens?\n2. **UI-Elemente**: Liste wichtige Komponenten mit Fachbegriffen (z.B. Navigation Bar, Hero Section, Card, Floating Action Button, Modal).\n3. **Inhalt**: Beschreibe sichtbare Texte, √úberschriften und Bilder.\n\nAntworte in einem flie√üenden, aber strukturierten Textblock, der als 'Alt-Text' bzw. Metadaten-Beschreibung dient."
          },
          {
            role: "user",
            content: [
              { type: "text", text: "Analysiere diesen Frame." },
              {
                type: "image_url",
                image_url: {
                  "url": `data:image/png;base64,${base64Image}`
                }
              }
            ]
          }
        ],
        max_tokens: 500
      })
    });

    const data = await response.json();
    if (data.choices && data.choices.length > 0) {
      input.value = data.choices[0].message.content;
    } else {
      console.error("Keine Antwort von AI", data);
      alert("Keine Antwort von der AI erhalten.");
    }
  } catch (error) {
    console.error("Fehler bei AI Request:", error);
    alert("Fehler bei der AI-Generierung.");
  } finally {
    resetAiBtn();
  }
}

aiBtn.onclick = () => {
  if (!apiKey) {
    alert("API Key fehlt! Bitte .env pr√ºfen.");
    return;
  }
  
  aiBtn.style.opacity = '0.5';
  aiBtn.style.cursor = 'wait';
  aiBtn.disabled = true;

  // Trigger Image Export in code.ts
  parent.postMessage({ pluginMessage: { type: 'get-image-for-ai' } }, '*');
};

document.getElementById('save').onclick = () => {
  const altText = input.value;
  parent.postMessage({ pluginMessage: { type: 'save-alt-text', altText } }, '*')
}

document.getElementById('search-btn').onclick = () => {
  const query = searchInput.value;
  if (!query) return;
  
  if (!apiKey) {
    alert("API Key fehlt! Bitte .env pr√ºfen.");
    return;
  }

  searchBtn.textContent = "üîç Analysiere...";
  searchBtn.disabled = true;

  // Schritt 1: Daten aus Figma holen
  parent.postMessage({ pluginMessage: { type: 'collect-all-frames', query } }, '*')
}

async function performAiSearch(query, framesData) {
  if (framesData.length === 0) {
    alert("Keine Frames mit Alt-Texten gefunden.");
    resetSearchBtn();
    return;
  }

  try {
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: "gpt-3.5-turbo",
        messages: [
          {
            role: "system",
            content: "Du bist eine intelligente Suchmaschine f√ºr UI-Designs. Du erh√§ltst eine Liste von Frames (mit ID und Beschreibung) und eine Suchanfrage. Deine Aufgabe ist es, den Frame zu finden, der am besten zur Anfrage passt. Antworte AUSSCHLIESSLICH mit der 'sid' des besten Treffers als reinen String. Wenn nichts passt, antworte mit 'null'."
          },
          {
            role: "user",
            content: `Suchanfrage: "${query}"\n\nVerf√ºgbare Frames:\n${JSON.stringify(framesData)}`
          }
        ],
        temperature: 0.0
      })
    });

    const data = await response.json();
    if (data.choices && data.choices.length > 0) {
      const resultSid = data.choices[0].message.content.trim();
      
      if (resultSid && resultSid !== 'null') {
        // Schritt 3: Zum gefundenen Frame navigieren
        parent.postMessage({ pluginMessage: { type: 'zoom-to-sid', sid: resultSid } }, '*');
      } else {
        alert("Kein passender Frame gefunden.");
      }
    } else {
      console.error("Keine Antwort von AI", data);
    }
  } catch (error) {
    console.error("Fehler bei AI Search:", error);
    alert("Fehler bei der Suche.");
  } finally {
    resetSearchBtn();
  }
}

function resetSearchBtn() {
  searchBtn.textContent = "AI Suche starten";
  searchBtn.disabled = false;
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

// NEU: Export Logik
exportBtn.onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'export-database' } }, '*');
};

function downloadJSON(data) {
  const jsonString = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonString], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `figma-alt-data-${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>
